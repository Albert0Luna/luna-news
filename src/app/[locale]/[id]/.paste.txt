export default async function Page ({params}: {params: {id: string}}) {
  
  //const t = await useTranslations('Date');

  const cookieStore = cookies();
  const lang = cookieStore.get('NEXT_LOCALE');

  let selectedNew;

  const prefix =  params.id.split('_');
  const suffixLower = prefix[1].toLowerCase();
  let selectedLang;

  if (!lang?.value) {
    selectedLang = suffixLower;
  } else {
    selectedLang = lang?.value;
  }

  if (selectedLang === 'en') {
    //?Get the prefix
    const prefix = params.id.split('_');
    const suffix = prefix[1].toLowerCase();
    //? Get the new code
    const parts = params.id.split('__');
    const newCode = parts[1];
    const selectData = await fetchNewsEn(newCode, params.id);

    if (!(selectedLang === suffix)) {
      redirect(`/${selectData?._id}`);
      return; 
    }
    selectedNew = selectData;
  } else if (selectedLang === 'es') {
    //?Get the prefix
    const prefix = params.id.split('_');
    const suffix = prefix[1].toLowerCase();
    //?Get the newCode
    const parts = params.id.split('__');
    const newCode = parts[1];
    const selectData = await fetchNewsEs(newCode);

    if (!(selectedLang === suffix)) {
      redirect(`/${selectData?._id}`);
      return;
    }
    selectedNew = selectData;
  }

  
  const fechaDB = selectedNew?.createdAt;

  const currentDate = new Date();
  const updateDate = new Date((fechaDB) as string);

  const dateSinceUpdateDays = (updateDate.getTime() - currentDate.getTime()) / (1000 * 60 * 60 * 24);

  const dateSinceUpdateMonth = dateSinceUpdateDays / 31;

  const dateSinceUpdateYear = dateSinceUpdateDays / 365;

  const rtf = new Intl.RelativeTimeFormat(lang?.value || suffixLower);

  //*? Last update

  const lastUpdate = selectedNew?.updatedAt;

  const lastUpdateDate = new Date((lastUpdate as string));

  const lastUpdateDays = (lastUpdateDate.getTime() - currentDate.getTime()) / (1000 * 60 * 60 * 24);

  const lastUpdateMonth = lastUpdateDays / 31;

  const lastUpdateYear = lastUpdateDays / 365;



  return (
    <main>
      {/**<Adsense /> */}
      <section className='new'>
        <h1 className='new_title'>{selectedNew?.title}</h1>
        <p className='new_read_time'>{selectedNew?.read_time}</p>
        <div className='new_info'>
      
          <div className='new_info_text'>
            {<Profile authorId={selectedNew?.author_id}/>}

            <p className='new_info_date'>
              {
                lastUpdate !== fechaDB
                  ? Number.isFinite(Math.round(lastUpdateYear)) && Math.round(lastUpdateYear) < 0
                    ? `${lang?.value === 'en' ? 'Last update' : 'Última actualización'} ${rtf.format(Math.round(lastUpdateYear), 'year')}`
                    : Number.isFinite(Math.round(lastUpdateMonth)) && Math.round(lastUpdateMonth) < 0
                      ? `${lang?.value === 'en' ? 'Last update' : 'Última actualización'} ${rtf.format(Math.round(lastUpdateMonth), 'month')}`
                      : Number.isFinite(Math.round(lastUpdateDays)) && Math.round(lastUpdateDays) === -1
                        ? `${lang?.value === 'en' ? 'Last update today' : 'Última actualización hoy'}`
                        : `${lang?.value === 'en' ? 'Last update' : 'Última actualización'} ${rtf.format(Math.round(lastUpdateDays) + 1, 'day')}`
                  : Number.isFinite(Math.round(dateSinceUpdateYear)) && Math.round(dateSinceUpdateYear) < 0
                    ? `${lang?.value === 'en' ? 'Written' : 'Escrito'} ${rtf.format(Math.round(dateSinceUpdateYear), 'year')}`
                    : Number.isFinite(Math.round(dateSinceUpdateMonth)) && Math.round(dateSinceUpdateMonth) < 0
                      ? `${lang?.value === 'en' ? 'Written' : 'Escrito'} ${rtf.format(Math.round(dateSinceUpdateMonth), 'month')}`
                      : Number.isFinite(Math.round(dateSinceUpdateDays)) && Math.round(dateSinceUpdateDays) === -1
                        ? `${lang?.value === 'en' ? 'Written today' : 'Escrito hoy'}`
                        : `${lang?.value === 'en' ? 'Written' : 'Escrito'} ${rtf.format(Math.round(dateSinceUpdateDays) + 1, 'day')}`
              }
            </p>
          </div>

          <picture className='new_info_image_container'>
            <img 
              className='new_info_image'
              src={selectedNew?.main_image} 
              alt={selectedNew?.image_alt} 
            />
            <small>
              {`${selectedNew === 'en' ? 'Fuente:' : 'Source:'}`} <a href={selectedNew?.main_image_source.url} className='new_info_source' >{selectedNew?.main_image_source.source_name}</a>
            </small>
          </picture>
        </div>

        <article className='article'>
          {
            selectedNew?.content.map((item : string, index: number) => (
              <>
                <MDXRemote key={index} source={item} />


                {/*<GoogleAdUnit>
                  <ins className="adsbygoogle"
                    style={{display: 'block', textAlign: 'center'}}
                    data-ad-layout="in-article"
                    data-ad-format="fluid"
                    data-ad-client="ca-pub-5368714617786898"
                    data-ad-slot="8032217154"></ins>
                </GoogleAdUnit>
                */}
                
              </>
            ))
          }
          <MDXRemote source={(selectedNew?.conclusion as string)} />

        </article>
      </section>
    </main>
  );
}